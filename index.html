<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, update, push, onValue, onChildAdded, get, query, limitToLast } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyC8QrDc5NiyyEZwl8sqBSVEPkymTkpgOiU",
        authDomain: "leetopia-auction.firebaseapp.com",
        databaseURL: "https://leetopia-auction-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "leetopia-auction",
        storageBucket: "leetopia-auction.firebasestorage.app",
        messagingSenderId: "396746559389",
        appId: "1:396746559389:web:21fa42ddc49366b6106974"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // State
    let currentUser = null;
    let timerInt = null;
    let currentAuction = null;
    let userBalance = 0;
    let currentChatPartner = null;
    let hasShownWinnerModal = false;
    let currentTargetGrowID = null;

    // Check if already logged in
    const savedUser = localStorage.getItem("currentUser");
    if (savedUser) {
        currentUser = JSON.parse(savedUser);
        showMainApp();
    }

    function showNotification(message, type = 'info', duration = 3000) {
        const notif = document.createElement('div');
        notif.className = `notification ${type}`;
        notif.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i> ${message}`;
        document.body.appendChild(notif);
        setTimeout(() => notif.remove(), duration);
    }

    // Auth Tab Switching
    window.switchAuthTab = function(tab) {
        document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));
        
        if (tab === 'login') {
            document.querySelectorAll('.auth-tab')[0].classList.add('active');
            document.getElementById('loginForm').classList.add('active');
        } else {
            document.querySelectorAll('.auth-tab')[1].classList.add('active');
            document.getElementById('registerForm').classList.add('active');
        }
    };

    // Register Function
    window.register = async function() {
        const username = document.getElementById('regUsername').value.trim().toLowerCase();
        const password = document.getElementById('regPassword').value;
        const growid = document.getElementById('regGrowID').value.trim();

        if (!username || !password || !growid) {
            return showNotification("Semua field harus diisi!", "error");
        }

        if (username.length < 3 || password.length < 4) {
            return showNotification("Username min 3 karakter, Password min 4 karakter!", "error");
        }

        try {
            const snap = await get(ref(db, `accounts/${username}`));
            if (snap.exists()) {
                return showNotification("Username sudah terdaftar!", "error");
            }

            await set(ref(db, `accounts/${username}`), {
                password: password,
                growid: growid,
                createdAt: Date.now()
            });

            await set(ref(db, `users/${growid}/balance`), 0);

            showNotification("Akun berhasil dibuat! Silakan login.", "success");
            
            document.getElementById('regUsername').value = '';
            document.getElementById('regPassword').value = '';
            document.getElementById('regGrowID').value = '';
            switchAuthTab('login');
        } catch (error) {
            showNotification("Error: " + error.message, "error");
        }
    };

    // Login Function
    window.login = async function() {
        const username = document.getElementById('loginUsername').value.trim().toLowerCase();
        const password = document.getElementById('loginPassword').value;

        if (!username || !password) {
            return showNotification("Username dan password harus diisi!", "error");
        }

        try {
            const snap = await get(ref(db, `accounts/${username}`));
            if (!snap.exists()) {
                return showNotification("Username tidak ditemukan!", "error");
            }

            const account = snap.val();
            if (account.password !== password) {
                return showNotification("Password salah!", "error");
            }

            currentUser = {
                username: username,
                growid: account.growid,
                isOwner: false
            };

            localStorage.setItem("currentUser", JSON.stringify(currentUser));
            showNotification(`Selamat datang, ${account.growid}!`, "success");
            showMainApp();
        } catch (error) {
            showNotification("Error: " + error.message, "error");
        }
    };

    // Owner Login
    window.ownerLogin = function() {
        const pass = document.getElementById("ownerPass").value;
        if (pass === "12345") {
            currentUser = {
                username: "owner",
                growid: "OWNER",
                isOwner: true
            };
            localStorage.setItem("currentUser", JSON.stringify(currentUser));
            showNotification("Login Owner berhasil!", "success");
            showMainApp();
        } else {
            showNotification("Password owner salah!", "error");
        }
    };

    // Logout
    window.logout = function() {
        currentUser = null;
        localStorage.removeItem("currentUser");
        location.reload();
    };

    // Show Main Application - FIXED VERSION
    function showMainApp() {
        // Hide auth panel completely
        const authPanel = document.getElementById('panelAuth');
        authPanel.classList.remove('active');
        authPanel.style.display = 'none';
        
        // Show navigation and header
        document.getElementById('mainNav').style.display = 'flex';
        document.getElementById('headerUserInfo').style.display = 'flex';
        
        // Update user info display
        document.getElementById('growidText').innerText = currentUser.growid;
        document.getElementById('profileUsername').innerText = currentUser.username;
        document.getElementById('profileGrowID').innerText = currentUser.growid;
        
        // Handle Owner-specific UI
        if (currentUser.isOwner) {
            document.getElementById('adminBadge').style.display = 'inline-block';
            document.getElementById('ownerPanelSection').style.display = 'block';
            // Owner gets special display
            document.getElementById("userBalance").innerText = "âˆž";
            document.getElementById("walletBalance").innerText = "âˆž";
            document.getElementById("bidBalance").innerText = "Owner Mode";
        } else {
            document.getElementById('adminBadge').style.display = 'none';
            document.getElementById('ownerPanelSection').style.display = 'none';
        }
        
        // Switch to auction panel by default
        switchPanel('auction');
        
        // Initialize data
        if (!currentUser.isOwner) {
            initUserBalance();
            loadTransactions();
        }
        
        loadPrivateChats();
    }

    // Panel Switching - FIXED VERSION
    window.switchPanel = function(panelName) {
        // Normalize panel name (first letter uppercase, rest lowercase)
        const capitalized = panelName.charAt(0).toUpperCase() + panelName.slice(1).toLowerCase();
        
        // Hide all panels
        document.querySelectorAll(".panel").forEach(panel => {
            panel.classList.remove("active");
            panel.style.display = 'none';
        });
        
        // Show target panel
        const targetPanel = document.getElementById("panel" + capitalized);
        if (targetPanel) {
            targetPanel.style.display = 'block';
            targetPanel.classList.add("active");
        }
        
        // Update nav buttons
        document.querySelectorAll(".nav button").forEach(btn => btn.classList.remove("active"));
        const targetTab = document.getElementById("tab" + capitalized);
        if (targetTab) {
            targetTab.classList.add("active");
        }
    };

    window.showOwnerSection = function(section) {
        document.getElementById("auctionCtrl").style.display = section === 'auctionCtrl' ? 'block' : 'none';
        document.getElementById("balanceCtrl").style.display = section === 'balanceCtrl' ? 'block' : 'none';
    };

    // User Balance
    async function initUserBalance() {
        const snap = await get(ref(db, `users/${currentUser.growid}/balance`));
        userBalance = snap.exists() ? snap.val() : 0;
        updateBalanceDisplay();
        
        onValue(ref(db, `users/${currentUser.growid}/balance`), s => {
            userBalance = s.exists() ? s.val() : 0;
            updateBalanceDisplay();
        });
    }

    function updateBalanceDisplay() {
        if (currentUser.isOwner) return; // Skip for owner
        
        document.getElementById("userBalance").innerText = userBalance.toLocaleString();
        document.getElementById("walletBalance").innerText = userBalance.toLocaleString();
        document.getElementById("bidBalance").innerText = userBalance.toLocaleString() + " BGL";
        document.getElementById("equivalentDL").innerText = (userBalance * 100).toLocaleString();
        document.getElementById("equivalentWL").innerText = (userBalance * 10000).toLocaleString();
        
        const bidBtn = document.getElementById("bidButton");
        if (currentAuction && currentAuction.status === 'active') {
            if (userBalance <= 0) {
                bidBtn.disabled = true;
                bidBtn.innerHTML = '<i class="fas fa-lock"></i> Saldo Tidak Cukup';
                bidBtn.style.opacity = '0.6';
            } else {
                bidBtn.disabled = false;
                bidBtn.innerHTML = '<i class="fas fa-gavel"></i> Place Bid';
                bidBtn.style.opacity = '1';
            }
        }
    }

    // Search Player
    window.searchPlayer = async function() {
        const username = document.getElementById('targetUsername').value.trim().toLowerCase();
        
        if (!username) {
            return showNotification("Masukkan username player!", "error");
        }

        try {
            const snap = await get(ref(db, `accounts/${username}`));
            
            if (!snap.exists()) {
                document.getElementById('playerInfo').style.display = 'none';
                return showNotification("Player tidak ditemukan!", "error");
            }

            const account = snap.val();
            currentTargetGrowID = account.growid;
            
            const balanceSnap = await get(ref(db, `users/${currentTargetGrowID}/balance`));
            const balance = balanceSnap.exists() ? balanceSnap.val() : 0;

            document.getElementById('foundUsername').innerText = username;
            document.getElementById('foundGrowID').innerText = account.growid;
            document.getElementById('foundBalance').innerText = balance.toLocaleString();
            document.getElementById('playerInfo').style.display = 'block';
            
            showNotification(`Player ${username} ditemukan! Saldo: ${balance} BGL`, "success");
        } catch (error) {
            showNotification("Error: " + error.message, "error");
        }
    };

    // Give BGL
    window.giveBGL = async function() {
        if (!currentTargetGrowID) {
            return showNotification("Cari player terlebih dahulu!", "error");
        }

        const amount = parseFloat(document.getElementById('bglAmount').value);
        
        if (!amount || amount <= 0) {
            return showNotification("Masukkan jumlah BGL yang valid!", "error");
        }

        try {
            const snap = await get(ref(db, `users/${currentTargetGrowID}/balance`));
            const currentBal = snap.exists() ? snap.val() : 0;
            const newBal = currentBal + amount;

            await set(ref(db, `users/${currentTargetGrowID}/balance`), newBal);

            await push(ref(db, `users/${currentTargetGrowID}/transactions`), {
                type: 'deposit',
                amount: amount,
                by: currentUser.growid,
                timestamp: Date.now(),
                note: `Deposit ${amount} BGL dari Owner`
            });

            await push(ref(db, `private/${currentTargetGrowID}/system`), {
                from: 'SYSTEM',
                message: `ðŸŽ Anda menerima ${amount} BGL dari Owner! Saldo: ${newBal} BGL`,
                timestamp: Date.now(),
                type: 'notification'
            });

            document.getElementById('foundBalance').innerText = newBal.toLocaleString();
            document.getElementById('bglAmount').value = '';
            
            showNotification(`Berhasil memberikan ${amount} BGL!`, "success");
        } catch (error) {
            showNotification("Error: " + error.message, "error");
        }
    };

    // Take BGL
    window.takeBGL = async function() {
        if (!currentTargetGrowID) {
            return showNotification("Cari player terlebih dahulu!", "error");
        }

        const amount = parseFloat(document.getElementById('bglAmount').value);
        
        if (!amount || amount <= 0) {
            return showNotification("Masukkan jumlah BGL yang valid!", "error");
        }

        try {
            const snap = await get(ref(db, `users/${currentTargetGrowID}/balance`));
            const currentBal = snap.exists() ? snap.val() : 0;

            if (currentBal < amount) {
                return showNotification(`Saldo tidak cukup! Saldo: ${currentBal} BGL`, "error");
            }

            const newBal = currentBal - amount;

            await set(ref(db, `users/${currentTargetGrowID}/balance`), newBal);

            await push(ref(db, `users/${currentTargetGrowID}/transactions`), {
                type: 'withdraw',
                amount: -amount,
                by: currentUser.growid,
                timestamp: Date.now(),
                note: `Withdraw ${amount} BGL oleh Owner`
            });

            await push(ref(db, `private/${currentTargetGrowID}/system`), {
                from: 'SYSTEM',
                message: `âš ï¸ Owner menarik ${amount} BGL. Saldo: ${newBal} BGL`,
                timestamp: Date.now(),
                type: 'notification'
            });

            document.getElementById('foundBalance').innerText = newBal.toLocaleString();
            document.getElementById('bglAmount').value = '';
            
            showNotification(`Berhasil menarik ${amount} BGL!`, "success");
        } catch (error) {
            showNotification("Error: " + error.message, "error");
        }
    };

    // Owner Functions - Lelang
    window.createAuction = async function() {
        const name = document.getElementById("itemName").value.trim();
        const qty = document.getElementById("itemQty").value.trim();
        const img = document.getElementById("itemImg").value.trim();
        const duration = parseInt(document.getElementById("duration").value) || 5;
        const minBid = parseFloat(document.getElementById("minBid").value) || 1;

        if (!name || !qty) return showNotification("Nama item dan jumlah wajib diisi!", "error");

        const endTime = Date.now() + duration * 60000;
        
        await set(ref(db, "auction/current"), {
            itemName: name,
            itemQty: qty,
            imageUrl: img || `https://placehold.co/120x120?text=${encodeURIComponent(name)}`,
            highestBid: 0,
            highestBidder: "-",
            minBid: minBid,
            endTime: endTime,
            status: "active",
            createdBy: currentUser.growid,
            createdAt: Date.now(),
            totalBids: 0,
            participants: {}
        });
        
        await set(ref(db, "bids"), null);
        hasShownWinnerModal = false;
        showNotification("Lelang dimulai!", "success");
        
        ["itemName", "itemQty", "itemImg", "duration", "minBid"].forEach(id => {
            document.getElementById(id).value = "";
        });
    };

    window.endAuctionEarly = async function() {
        if (!currentAuction || currentAuction.status !== "active") {
            return showNotification("Tidak ada lelang aktif!", "error");
        }
        if (confirm("Yakin ingin mengakhiri lelang sekarang?")) {
            await processAuctionEnd();
        }
    };

    // Currency Conversion
    function convert(amount, currency) {
        switch(currency) {
            case "DL": return amount * 100;
            case "WL": return amount / 100;
            default: return amount;
        }
    }

    // Bid Functions
    window.placeBid = async function() {
        if (currentUser.isOwner) {
            return showNotification("Owner tidak bisa ikut bid!", "error");
        }
        
        const amt = parseFloat(document.getElementById("bidAmount").value);
        if (!amt || amt <= 0) return showNotification("Masukkan jumlah bid yang valid!", "error");

        const cur = document.getElementById("currency").value;
        const bidVal = convert(amt, cur);

        if (bidVal > userBalance) {
            return showNotification(`Saldo tidak cukup! Anda punya ${userBalance} BGL, butuh ${bidVal} BGL`, "error");
        }

        const snap = await get(ref(db, "auction/current"));
        const d = snap.val();
        
        if (!d || d.status !== "active") return showNotification("Tidak ada lelang aktif!", "error");
        if (Date.now() > d.endTime) return showNotification("Lelang sudah selesai!", "error");
        if (bidVal < d.minBid) return showNotification(`Bid minimal adalah ${d.minBid} BGL!`, "error");
        if (bidVal <= d.highestBid) return showNotification(`Bid harus lebih tinggi dari ${d.highestBid} BGL!`, "error");

        const userBidRef = ref(db, `auction/current/participants/${currentUser.growid}`);
        const userBidSnap = await get(userBidRef);
        let previousBid = 0;
        if (userBidSnap.exists()) {
            previousBid = userBidSnap.val().amount || 0;
        }

        const additionalNeeded = bidVal - previousBid;
        if (additionalNeeded > userBalance) {
            return showNotification(`Saldo tidak cukup untuk menaikkan bid! Butuh tambahan ${additionalNeeded} BGL`, "error");
        }

        await update(ref(db, `users/${currentUser.growid}`), {
            balance: userBalance - additionalNeeded,
            lockedBalance: (userBidSnap.exists() ? userBidSnap.val().locked || 0 : 0) + additionalNeeded
        });

        await update(ref(db, "auction/current"), {
            highestBid: bidVal,
            highestBidder: currentUser.growid,
            totalBids: (d.totalBids || 0) + 1
        });

        await set(ref(db, `auction/current/participants/${currentUser.growid}`), {
            amount: bidVal,
            locked: bidVal,
            timestamp: Date.now()
        });

        await push(ref(db, "bids"), {
            growid: currentUser.growid,
            amount: bidVal,
            currency: cur,
            originalAmount: amt,
            timestamp: Date.now()
        });

        document.getElementById("bidAmount").value = "";
        showNotification("Bid berhasil! Saldo telah dikunci.", "success");
    };

    // Process Auction End
    async function processAuctionEnd() {
        if (!currentAuction) return;
        
        const winner = currentAuction.highestBidder;
        const winAmount = currentAuction.highestBid;
        
        await update(ref(db, "auction/current"), {
            status: "ended",
            endTime: Date.now(),
            winner: winner,
            winAmount: winAmount
        });

        if (winner !== "-") {
            const winnerRef = ref(db, `users/${winner}`);
            const winnerSnap = await get(winnerRef);
            if (winnerSnap.exists()) {
                const data = winnerSnap.val();
                await update(winnerRef, {
                    balance: data.balance || 0,
                    lockedBalance: 0
                });

                await push(ref(db, `users/${winner}/transactions`), {
                    type: 'auction_win',
                    amount: -winAmount,
                    item: currentAuction.itemName,
                    timestamp: Date.now(),
                    note: `Pemenang lelang: ${currentAuction.itemName}`
                });
            }

            const participants = currentAuction.participants || {};
            for (let [pid, pdata] of Object.entries(participants)) {
                if (pid !== winner && pdata.locked) {
                    const pRef = ref(db, `users/${pid}`);
                    const pSnap = await get(pRef);
                    if (pSnap.exists()) {
                        const pData = pSnap.val();
                        await update(pRef, {
                            balance: (pData.balance || 0) + pdata.locked,
                            lockedBalance: (pData.lockedBalance || 0) - pdata.locked
                        });
                        await push(ref(db, `private/${pid}/system`), {
                            from: 'SYSTEM',
                            message: `Lelang selesai! Saldo terkunci ${pdata.locked} BGL telah dikembalikan.`,
                            timestamp: Date.now(),
                            type: 'refund'
                        });
                    }
                }
            }

            await push(ref(db, `private/${winner}/system`), {
                from: 'BOT_AUCTION',
                message: `ðŸŽ‰ SELAMAT! Anda memenangkan lelang ${currentAuction.itemName} dengan bid ${winAmount} BGL! Silakan buka tab Pesan untuk claim hadiah.`,
                timestamp: Date.now(),
                type: 'winner',
                data: {
                    item: currentAuction.itemName,
                    qty: currentAuction.itemQty,
                    amount: winAmount
                }
            });

            if (winner === currentUser.growid && !hasShownWinnerModal) {
                showWinnerModal(currentAuction, winAmount);
            }
        }
        showNotification("Lelang telah berakhir!", "info");
    }

    // Winner Modal
    window.showWinnerModal = function(auction, amount) {
        hasShownWinnerModal = true;
        document.getElementById("winItem").innerText = auction.itemName;
        document.getElementById("winQty").innerText = auction.itemQty;
        document.getElementById("winAmount").innerText = amount;
        document.getElementById("winnerModal").classList.add("active");
    };

    window.closeModal = function() {
        document.getElementById("winnerModal").classList.remove("active");
    };

    window.submitWinnerInfo = async function() {
        const wa = document.getElementById("winnerWA").value.trim();
        if (!wa || wa.length < 10) return showNotification("Masukkan nomor WA yang valid!", "error");

        await push(ref(db, "admin/winnerClaims"), {
            growid: currentUser.growid,
            wa: wa,
            item: currentAuction.itemName,
            qty: currentAuction.itemQty,
            amount: currentAuction.winAmount || currentAuction.highestBid,
            timestamp: Date.now(),
            status: "pending"
        });

        await push(ref(db, `private/${currentUser.growid}/system`), {
            from: 'BOT_AUCTION',
            message: `âœ… Data Anda telah dikirim ke owner! Nomor WA: ${wa}. Owner akan menghubungi Anda segera.`,
            timestamp: Date.now(),
            type: 'confirmation'
        });

        closeModal();
        showNotification("Data berhasil dikirim! Owner akan menghubungi Anda.", "success");
    };

    // Chat Functions
    window.sendChat = async function() {
        const text = document.getElementById("chatInput").value.trim();
        if (!text) return;
        if (text.length > 200) return showNotification("Pesan terlalu panjang!", "error");

        await push(ref(db, "chat"), {
            growid: currentUser.growid,
            message: text,
            timestamp: Date.now()
        });
        document.getElementById("chatInput").value = "";
    };

    // Private Chat
    async function loadPrivateChats() {
        const chatList = document.getElementById("privateChatList");
        
        onValue(query(ref(db, `private/${currentUser.growid}`), limitToLast(50)), snapshot => {
            chatList.innerHTML = "";
            const chats = snapshot.val() || {};
            
            let unread = 0;
            
            Object.entries(chats).forEach(([chatId, messages]) => {
                if (chatId === 'system') {
                    const msgs = Object.values(messages || {});
                    const lastMsg = msgs[msgs.length - 1];
                    
                    if (lastMsg) {
                        const div = document.createElement("div");
                        div.className = "chat-item system-chat";
                        if (!lastMsg.read) {
                            div.classList.add("unread");
                            unread++;
                        }
                        div.innerHTML = `
                            <div style="font-weight:700; color:#0a3a66;">
                                <i class="fas fa-robot"></i> Sistem
                            </div>
                            <div style="font-size:0.85rem; color:#666; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
                                ${lastMsg.message ? lastMsg.message.substring(0, 30) + '...' : 'Pesan sistem'}
                            </div>
                        `;
                        div.onclick = () => openPrivateChat('system');
                        chatList.appendChild(div);
                    }
                }
            });
            
            if (unread > 0) {
                document.getElementById("privateBadge").style.display = 'inline';
                document.getElementById("privateBadge").innerText = unread;
            }
        });
    }

    window.openPrivateChat = function(chatId) {
        currentChatPartner = chatId;
        document.getElementById("privateChatHeader").innerHTML = chatId === 'system' ? 
            '<i class="fas fa-robot"></i> Pesan Sistem (Bot)' : 
            `<i class="fas fa-user"></i> ${chatId}`;
        
        document.getElementById("privateInputArea").style.display = chatId === 'system' ? 'none' : 'flex';
        
        const messagesDiv = document.getElementById("privateMessages");
        onValue(ref(db, `private/${currentUser.growid}/${chatId}`), snapshot => {
            messagesDiv.innerHTML = "";
            const messages = snapshot.val() || {};
            
            Object.entries(messages).forEach(([key, msg]) => {
                const div = document.createElement("div");
                div.className = "chat-bubble";
                
                if (msg.from === 'SYSTEM' || msg.from === 'BOT_AUCTION') {
                    div.className += " system";
                    div.innerHTML = `<i class="fas fa-robot"></i> <b>${msg.from}</b><br>${msg.message}`;
                } else if (msg.from === currentUser.growid) {
                    div.className += " own";
                    div.innerHTML = `<b>Anda</b><br>${msg.message}`;
                } else {
                    div.innerHTML = `<b>${msg.from}</b><br>${msg.message}`;
                }
                
                if (msg.type === 'winner') div.className += " winner";
                messagesDiv.appendChild(div);
            });
            
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            
            if (chatId === 'system') {
                Object.keys(messages).forEach(key => {
                    if (!messages[key].read) {
                        update(ref(db, `private/${currentUser.growid}/${chatId}/${key}`), { read: true });
                    }
                });
            }
        });
    };

    window.sendPrivateMessage = async function() {
        if (!currentChatPartner || currentChatPartner === 'system') return;
        
        const text = document.getElementById("privateInput").value.trim();
        if (!text) return;

        await push(ref(db, `private/${currentChatPartner}/${currentUser.growid}`), {
            from: currentUser.growid,
            message: text,
            timestamp: Date.now(),
            read: false
        });

        await push(ref(db, `private/${currentUser.growid}/${currentChatPartner}`), {
            from: currentUser.growid,
            message: text,
            timestamp: Date.now(),
            read: true
        });

        document.getElementById("privateInput").value = "";
    };

    // Transaction History
    function loadTransactions() {
        const histDiv = document.getElementById("transactionHistory");
        
        onValue(query(ref(db, `users/${currentUser.growid}/transactions`), limitToLast(20)), snapshot => {
            if (!snapshot.exists()) {
                histDiv.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-receipt"></i>
                        <p>Belum ada transaksi</p>
                    </div>
                `;
                return;
            }
            
            histDiv.innerHTML = "";
            const transactions = snapshot.val();
            
            Object.entries(transactions).reverse().forEach(([id, t]) => {
                const div = document.createElement("div");
                div.className = `transaction-item ${t.type}`;
                const isPositive = t.amount > 0;
                div.innerHTML = `
                    <div>
                        <div style="font-weight:600;">${t.note || t.type}</div>
                        <div style="font-size:0.8rem; color:#666;">${new Date(t.timestamp).toLocaleString()}</div>
                    </div>
                    <div class="${isPositive ? 'amount-positive' : 'amount-negative'}">
                        ${isPositive ? '+' : ''}${t.amount} BGL
                    </div>
                `;
                histDiv.appendChild(div);
            });
        });
    }

    // Realtime Listeners
    onValue(ref(db, "auction/current"), s => {
        const d = s.val();
        currentAuction = d;
        
        if (!d) {
            document.getElementById("displayItem").innerText = "-";
            document.getElementById("displayQty").innerText = "0";
            document.getElementById("displayImg").src = "https://placehold.co/120x120?text=No+Item";
            document.getElementById("highestBid").innerText = "0";
            document.getElementById("highestBidder").innerText = "-";
            document.getElementById("minBidDisplay").innerText = "0";
            document.getElementById("timer").innerHTML = '<i class="fas fa-clock"></i> --:--';
            document.getElementById("auctionStatus").className = "status-badge status-ended";
            document.getElementById("auctionStatus").innerText = "Tidak Ada Lelang";
            document.getElementById("totalBids").innerText = "0";
            document.getElementById("participantCount").innerText = "0";
            if (timerInt) clearInterval(timerInt);
            return;
        }

        document.getElementById("displayItem").innerText = d.itemName || "-";
        document.getElementById("displayQty").innerText = d.itemQty || 0;
        document.getElementById("displayImg").src = d.imageUrl || "https://placehold.co/120x120?text=No+Image";
        document.getElementById("highestBid").innerText = d.highestBid || 0;
        document.getElementById("highestBidder").innerText = d.highestBidder || "-";
        document.getElementById("minBidDisplay").innerText = d.minBid || 1;
        document.getElementById("totalBids").innerText = d.totalBids || 0;
        document.getElementById("participantCount").innerText = d.participants ? Object.keys(d.participants).length : 0;
        
        const statusEl = document.getElementById("auctionStatus");
        if (d.status === "active" && Date.now() < d.endTime) {
            statusEl.className = "status-badge status-active";
            statusEl.innerText = "Lelang Aktif";
        } else {
            statusEl.className = "status-badge status-ended";
            statusEl.innerText = "Lelang Selesai";
        }

        if (timerInt) clearInterval(timerInt);
        
        timerInt = setInterval(() => {
            const remaining = d.endTime - Date.now();
            const timerEl = document.getElementById("timer");
            
            if (remaining <= 0 || d.status === "ended") {
                timerEl.innerHTML = '<i class="fas fa-flag-checkered"></i> SELESAI';
                timerEl.classList.add("ended");
                clearInterval(timerInt);
                
                if (d.status === "active") processAuctionEnd();
                if (d.highestBidder === currentUser.growid && d.status === "ended" && !hasShownWinnerModal) {
                    showWinnerModal(d, d.highestBid);
                }
            } else {
                const mins = Math.floor(remaining / 60000);
                const secs = Math.floor((remaining % 60000) / 1000);
                timerEl.innerHTML = `<i class="fas fa-clock"></i> ${mins}m ${secs.toString().padStart(2, '0')}s`;
                timerEl.classList.remove("ended");
            }
        }, 1000);
    });

    // Bid History
    const hist = document.getElementById("bidHistory");
    onChildAdded(query(ref(db, "bids"), limitToLast(20)), s => {
        const b = s.val();
        if (!b) return;
        
        if (hist.querySelector(".empty-state")) hist.innerHTML = "";
        
        const div = document.createElement("div");
        div.className = "chat-bubble";
        div.style.animation = "slideIn 0.3s ease";
        div.innerHTML = `
            <b>${b.growid}</b> 
            <span style="color:#0a58ca; font-weight:700;">${b.amount} BGL</span>
            <small style="color:#999; display:block; font-size:0.75rem;">
                ${b.currency} ${b.originalAmount} â€¢ ${new Date(b.timestamp).toLocaleTimeString()}
            </small>
        `;
        hist.prepend(div);
    });

    // Public Chat
    const chatDiv = document.getElementById("chatMessages");
    onChildAdded(query(ref(db, "chat"), limitToLast(50)), s => {
        const c = s.val();
        if (!c) return;
        
        if (chatDiv.querySelector(".empty-state")) chatDiv.innerHTML = "";
        
        const div = document.createElement("div");
        div.className = "chat-bubble" + (c.growid === currentUser.growid ? " own" : "");
        div.innerHTML = `<b>${c.growid}</b><br>${escapeHtml(c.message)}`;
        chatDiv.appendChild(div);
        chatDiv.scrollTop = chatDiv.scrollHeight;
    });

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    window.addEventListener('beforeunload', () => {
        if (timerInt) clearInterval(timerInt);
    });
</script>
