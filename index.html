<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Meatps Auction</title>
  <style>
    body {
      font-family: Arial;
      background: #0f172a;
      color: white;
      text-align: center;
    }
    h1 {
      color: #38bdf8;
      text-shadow: 0 0 10px #38bdf8;
    }
    .box {
      background: #1e293b;
      padding: 20px;
      border-radius: 12px;
      margin: 15px auto;
      width: 360px;
    }
    input, select, button {
      padding: 8px;
      margin: 5px;
      border-radius: 6px;
      border: none;
    }
    button {
      background: #3b82f6;
      color: white;
      cursor: pointer;
    }
    img {
      max-width: 200px;
      border-radius: 10px;
      margin-top: 10px;
    }
    .bid-item {
      background: #334155;
      margin: 5px;
      padding: 6px;
      border-radius: 6px;
      font-size: 14px;
    }
  </style>
</head>
<body>

<h1>üî• MEATPS AUCTION üî•</h1>

<div class="box">
  <h3>Profil</h3>
  <input id="growid" placeholder="Masukkan GrowID">
  <button onclick="saveProfile()">Simpan</button>
</div>

<div class="box">
  <h3>Owner Login</h3>
  <input type="password" id="ownerPass" placeholder="Password Owner">
  <button onclick="ownerLogin()">Login</button>
</div>

<div class="box" id="ownerPanel" style="display:none;">
  <h3>Buat Lelang</h3>
  <input id="itemName" placeholder="Nama Item"><br>
  <input type="number" id="itemQty" placeholder="Jumlah Item"><br>
  <input id="itemImg" placeholder="URL Gambar"><br>
  <input type="number" id="duration" placeholder="Durasi (menit)"><br>
  <button onclick="createAuction()">Start Lelang</button>
</div>

<div class="box">
  <h3 id="displayItem">Belum ada lelang</h3>
  <p>Jumlah: <span id="displayQty">-</span></p>
  <img id="displayImg">
  <h2>üí∞ <span id="highestBid">0</span> BGL</h2>
  <p>Bidder: <span id="highestBidder">-</span></p>
  <p id="timer">‚è±Ô∏è -</p>
</div>

<div class="box">
  <h3>Bid</h3>
  <input type="number" id="bidAmount" placeholder="Jumlah">
  <select id="currency">
    <option value="BGL">BGL</option>
    <option value="DL">DL</option>
    <option value="WL">WL</option>
  </select>
  <button onclick="placeBid()">Bid</button>
</div>

<div class="box">
  <h3>History Bid (Max 20)</h3>
  <div id="bidHistory"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, set, update, push, onValue, onChildAdded, get } 
from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyC8QrDc5NiyyEZwl8sqBSVEPkymTkpgOiU",
  authDomain: "leetopia-auction.firebaseapp.com",
  databaseURL: "https://leetopia-auction-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "leetopia-auction",
  storageBucket: "leetopia-auction.firebasestorage.app",
  messagingSenderId: "396746559389",
  appId: "1:396746559389:web:21fa42ddc49366b6106974"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

let currentGrowID = "";
let ownerPassword = "12345";

window.saveProfile = function(){
  currentGrowID = document.getElementById("growid").value;
  alert("Profil disimpan!");
}

window.ownerLogin = function(){
  const pass = document.getElementById("ownerPass").value;
  if(pass === ownerPassword){
    document.getElementById("ownerPanel").style.display = "block";
  } else {
    alert("Password salah!");
  }
}

window.createAuction = function(){
  const name = document.getElementById("itemName").value;
  const qty = document.getElementById("itemQty").value;
  const img = document.getElementById("itemImg").value;
  const duration = document.getElementById("duration").value;

  const endTime = Date.now() + duration * 60000;

  set(ref(db, "auction/current"), {
    itemName: name,
    itemQty: qty,
    imageUrl: img,
    highestBid: 0,
    highestBidder: "-",
    endTime: endTime
  });

  set(ref(db, "bids"), null);
}

function convertToBGL(amount, currency){
  if(currency === "BGL") return amount;
  if(currency === "DL") return amount * 100;
  if(currency === "WL") return amount / 100;
}

window.placeBid = function(){
  if(!currentGrowID){
    alert("Isi GrowID dulu!");
    return;
  }

  const amount = parseFloat(document.getElementById("bidAmount").value);
  const currency = document.getElementById("currency").value;
  const bidValue = convertToBGL(amount, currency);

  get(ref(db,"auction/current")).then(snapshot=>{
    const data = snapshot.val();
    if(!data) return;

    if(Date.now() > data.endTime){
      alert("Lelang selesai!");
      return;
    }

    if(bidValue > data.highestBid){
      update(ref(db,"auction/current"),{
        highestBid: bidValue,
        highestBidder: currentGrowID
      });

      push(ref(db,"bids"),{
        growid: currentGrowID,
        amount: bidValue,
        time: Date.now()
      });
    } else {
      alert("Bid harus lebih tinggi!");
    }
  });
}

onValue(ref(db,"auction/current"), snapshot=>{
  const data = snapshot.val();
  if(!data) return;

  document.getElementById("displayItem").innerText = data.itemName;
  document.getElementById("displayQty").innerText = data.itemQty;
  document.getElementById("displayImg").src = data.imageUrl;
  document.getElementById("highestBid").innerText = data.highestBid;
  document.getElementById("highestBidder").innerText = data.highestBidder;

  const timerInterval = setInterval(()=>{
    const remaining = data.endTime - Date.now();
    if(remaining <= 0){
      document.getElementById("timer").innerText = "‚õî Selesai";
      clearInterval(timerInterval);
    } else {
      const m = Math.floor(remaining/60000);
      const s = Math.floor((remaining%60000)/1000);
      document.getElementById("timer").innerText = `‚è±Ô∏è ${m}m ${s}s`;
    }
  },1000);
});

let bidCount = 0;
onChildAdded(ref(db,"bids"), snapshot=>{
  const bid = snapshot.val();
  const div = document.createElement("div");
  div.className = "bid-item";
  div.innerText = bid.growid + " bid " + bid.amount + " BGL";
  document.getElementById("bidHistory").prepend(div);

  bidCount++;
  if(bidCount > 20){
    document.getElementById("bidHistory").lastChild.remove();
  }
});
</script>

</body>
</html>
