<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
  <title>GTPS Auction ¬∑ Growtopia Lelang</title>

  <!-- Firebase v8 -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>

  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #0b0f1c;
      color: #eef3fc;
      padding: 0 0 85px 0;
      min-height: 100vh;
    }

    /* header */
    .app-header {
      background: #141b2b;
      padding: 18px 20px 12px;
      border-bottom: 2px solid #2d3e62;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
    }

    .logo h1 {
      font-size: 1.9rem;
      background: linear-gradient(145deg, #fdbb4c, #ffe184);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      font-weight: 800;
      letter-spacing: -0.5px;
    }

    .menu-icons {
      display: flex;
      gap: 14px;
    }

    .icon-btn {
      background: #1f2a41;
      border: 1px solid #3e506f;
      color: white;
      padding: 10px 16px;
      border-radius: 40px;
      font-weight: 600;
      font-size: 0.95rem;
      box-shadow: 0 4px 0 #0b101d;
      transition: 0.1s;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .icon-btn:active {
      transform: translateY(4px);
      box-shadow: 0 1px 0 #0b101d;
    }

    /* SVG icons */
    .svg-icon {
      width: 20px;
      height: 20px;
      fill: none;
      stroke: currentColor;
      stroke-width: 2;
      stroke-linecap: round;
      stroke-linejoin: round;
    }

    /* page */
    .page {
      display: none;
      padding: 20px 16px;
      animation: fade 0.2s;
    }

    .page.active { display: block; }

    @keyframes fade { from { opacity: 0.4; } to { opacity: 1; } }

    .card {
      background: #192132;
      border-radius: 32px;
      padding: 22px 18px;
      margin-bottom: 22px;
      border: 1px solid #2d3b59;
      box-shadow: 0 15px 25px -10px #000000b0;
    }

    .flex-row {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
    }

    .grid-2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    input, textarea, select {
      width: 100%;
      padding: 15px 22px;
      background: #0e1424;
      border: 1.5px solid #2d3b59;
      border-radius: 60px;
      font-size: 1rem;
      color: #ffffff;
      outline: none;
    }

    input:focus { border-color: #f5b342; }

    button {
      background: #f5b342;
      border: none;
      padding: 15px 24px;
      border-radius: 60px;
      font-weight: 700;
      font-size: 1rem;
      color: #0b0f1c;
      box-shadow: 0 7px 0 #b3701c;
      cursor: pointer;
      transition: 0.1s;
      width: fit-content;
    }

    button:active {
      transform: translateY(5px);
      box-shadow: 0 2px 0 #b3701c;
    }

    .btn-secondary {
      background: transparent;
      border: 2px solid #f5b342;
      color: #f5b342;
      box-shadow: none;
    }

    .image-preview {
      width: 100%;
      aspect-ratio: 1/1;
      background: #0e1424;
      border-radius: 30px;
      border: 2px dashed #42527a;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      margin: 16px 0;
      cursor: pointer;
    }

    .image-preview img { width: 100%; height: 100%; object-fit: cover; }

    .badge {
      background: #253452;
      padding: 6px 18px;
      border-radius: 40px;
      font-weight: 500;
    }

    .currency-tabs {
      display: flex;
      gap: 6px;
      background: #0e1424;
      padding: 6px;
      border-radius: 60px;
      margin: 15px 0;
    }

    .currency-tabs span {
      flex: 1;
      text-align: center;
      padding: 11px 0;
      border-radius: 50px;
      font-weight: 700;
      background: transparent;
      color: #9bb1df;
      transition: 0.2s;
    }

    .currency-tabs span.active {
      background: #f5b342;
      color: #0b0f1c;
    }

    .bid-history-item {
      background: #0e1424;
      border-radius: 30px;
      padding: 14px 20px;
      margin: 10px 0;
      display: flex;
      justify-content: space-between;
      border-left: 5px solid #f5b342;
    }

    .profile-pic-large {
      width: 60px;
      height: 60px;
      border-radius: 40px;
      background: #f5b342;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 800;
      font-size: 2rem;
      color: #0b0f1c;
    }

    .chat-bubble {
      background: #1b253f;
      border-radius: 25px 25px 25px 8px;
      padding: 14px 18px;
      margin: 8px 0;
      max-width: 85%;
      word-break: break-word;
    }

    .chat-bubble.own {
      background: #1f5a2a;
      border-radius: 25px 25px 8px 25px;
      margin-left: auto;
    }

    #chatContainer {
      max-height: 280px;
      overflow-y: auto;
      padding: 6px;
      display: flex;
      flex-direction: column;
    }

    /* bottom navigation */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background: #141b2b;
      border-top: 2px solid #2d3e62;
      display: flex;
      justify-content: space-around;
      padding: 8px 0 18px;
      z-index: 100;
    }

    .nav-item {
      flex: 1;
      text-align: center;
      color: #6f86b0;
      font-weight: 600;
      font-size: 0.8rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      cursor: pointer;
    }

    .nav-item.active { color: #f5b342; }

    .nav-item svg {
      width: 26px;
      height: 26px;
      stroke: currentColor;
      stroke-width: 1.8;
      fill: none;
    }

    .hidden { display: none !important; }

    hr { border: 1px solid #253a5a; margin: 20px 0; }
  </style>
</head>
<body>

<!-- header with two menu buttons (Profile & Owner) -->
<div class="app-header">
  <div class="logo"><h1>GTPS Auction</h1></div>
  <div class="menu-icons">
    <button class="icon-btn" id="profileMenuBtn">
      <svg class="svg-icon" viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
      Profil
    </button>
    <button class="icon-btn" id="ownerMenuBtn">
      <svg class="svg-icon" viewBox="0 0 24 24"><path d="M12 2v4M12 22v-4M4 12H2h2m16 0h2-2M5.636 5.636l2.828 2.828M15.536 15.536l2.828 2.828M5.636 18.364l2.828-2.828M15.536 8.464l2.828-2.828"/><circle cx="12" cy="12" r="4"/></svg>
      Owner
    </button>
  </div>
</div>

<!-- PAGE: AUCTION (beranda) -->
<div id="pageAuction" class="page active">
  <div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center;">
      <h2 style="font-size: 1.9rem;" id="itemDisplay">‚è≥ lelang sepi</h2>
      <span class="badge" id="itemQtyDisplay">x0</span>
    </div>

    <!-- gambar item 1:1 -->
    <div class="image-preview" id="auctionImageBox">
      <img id="auctionImg" src="https://placehold.co/400x400/192132/f5b342?text=Item" alt="item">
    </div>

    <!-- timer -->
    <div class="badge" style="font-size: 1.6rem; background:#0e1424; margin:12px 0; display:inline-block;" id="timer">‚è±Ô∏è --:--</div>

    <div class="grid-2" style="margin: 16px 0;">
      <div><span style="color:#a0b8e6;">üí∞ Tertinggi</span><br><span style="font-size: 2rem;font-weight:700;" id="highestBid">0</span></div>
      <div><span style="color:#a0b8e6;">üëë Bidder</span><br><span style="font-size:1.8rem;" id="highestBidder">-</span></div>
    </div>

    <!-- bid area -->
    <div style="background:#0e1424; border-radius: 40px; padding: 18px;">
      <div class="currency-tabs" id="currencyTabs">
        <span class="active" data-cur="WL">WL</span>
        <span data-cur="DL">DL</span>
        <span data-cur="BGL">BGL</span>
        <span data-cur="MGL">MGL</span>
      </div>
      <div class="flex-row">
        <input type="number" id="bidAmount" placeholder="jumlah" style="flex:3;" value="1">
        <button onclick="placeBid()" style="flex:1;">Bid</button>
      </div>
      <p style="font-size:0.8rem; margin-top:10px; color:#99add5;">1 DL = 100 WL ¬∑ 1 BGL = 100 DL ¬∑ 1 MGL = 100 BGL</p>
    </div>

    <!-- bid history -->
    <div style="margin-top: 28px;">
      <h3 style="display: flex; gap:6px; margin-bottom:12px;">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#f5b342"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6z"/><path d="M14 2v6h6M16 13H8M16 17H8M10 9H8"/></svg>
        Riwayat bid
      </h3>
      <div id="bidHistory"></div>
    </div>
  </div>
</div>

<!-- PAGE: PROFIL -->
<div id="pageProfile" class="page">
  <div class="card">
    <h2 style="display: flex; gap:8px; margin-bottom:20px;">
      <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#f5b342" stroke-width="1.8"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
      Data peserta
    </h2>

    <div id="profileForm">
      <input type="text" id="profileGrowid" placeholder="GrowID" value="">
      <input type="text" id="profileWA" placeholder="Nomor WhatsApp (628xx)" value="" style="margin-top: 15px;">
      <div style="display: flex; gap: 16px; margin-top: 24px;">
        <button onclick="saveProfile()">Simpan Profil</button>
        <div class="profile-pic-large" id="profileInitial">GT</div>
      </div>
    </div>

    <div id="profileDisplay" style="display: none; align-items: center; gap: 20px;">
      <div class="profile-pic-large" id="displayInitial">GT</div>
      <div><strong id="displayGrowid">-</strong><br><span id="displayWA" style="color:#a0b8e6;"></span></div>
      <button class="btn-secondary" onclick="editProfile()" style="margin-left: auto;">Ubah</button>
    </div>
  </div>
</div>

<!-- PAGE: OWNER PANEL (terpisah) -->
<div id="pageOwner" class="page">
  <div class="card" style="border-color: #f5b342;">
    <h2 style="display: flex; gap:8px;">
      <svg width="28" height="28" viewBox="0 0 24 24" stroke="#f5b342" fill="none"><path d="M12 2v4M12 22v-4M4 12H2h2m16 0h2-2M5.636 5.636l2.828 2.828M15.536 15.536l2.828 2.828M5.636 18.364l2.828-2.828M15.536 8.464l2.828-2.828"/><circle cx="12" cy="12" r="4"/></svg>
      Owner Panel
    </h2>

    <div class="flex-row" style="margin:20px 0;">
      <input type="password" id="ownerPass" placeholder="password owner" style="flex:2;">
      <button onclick="loginOwner()" class="btn-secondary" style="flex:1;">Login</button>
    </div>

    <div id="ownerControls" style="display: none;">
      <div class="grid-2">
        <input type="text" id="itemName" placeholder="Nama item" value="Magplant">
        <input type="number" id="itemQty" placeholder="Jumlah" value="1" min="1">
      </div>

      <!-- upload gambar 1:1 -->
      <div class="image-preview" id="ownerImagePreview" onclick="document.getElementById('itemImageInput').click()">
        <img id="previewImg" src="https://placehold.co/400x400/192132/f5b342?text=Tap+to+upload" style="width:100%;">
      </div>
      <input type="file" id="itemImageInput" accept="image/*" style="display: none;" onchange="handleImageUpload(event)">

      <div class="grid-2" style="margin-top: 10px;">
        <input type="number" id="startPriceBGL" placeholder="Start price (BGL)" value="1" step="0.01">
        <input type="number" id="duration" placeholder="Durasi (menit)" value="5" min="1">
      </div>

      <button onclick="startAuction()" style="width: 100%; margin-top: 12px;">Mulai Lelang</button>
    </div>
  </div>
</div>

<!-- PAGE: CHAT ROOM (terpisah) -->
<div id="pageChat" class="page">
  <div class="card" style="min-height: 70vh; display: flex; flex-direction: column;">
    <h2 style="display: flex; gap:8px;">
      <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#f5b342"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
      Chat lelang
    </h2>

    <div id="chatContainer" style="flex:1; background:#0e1424; border-radius: 30px; padding: 12px;"></div>

    <div class="flex-row" style="margin-top: 18px;">
      <input type="text" id="chatMsg" placeholder="Tulis pesan..." style="flex:3;">
      <button onclick="sendChat()" style="flex:1;">Kirim</button>
    </div>
  </div>
</div>

<!-- bottom navigation (menu: rumah, chat, profil, owner) -->
<div class="bottom-nav">
  <div class="nav-item active" data-page="auction">
    <svg viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
    <span>Lelang</span>
  </div>
  <div class="nav-item" data-page="chat">
    <svg viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
    <span>Chat</span>
  </div>
  <div class="nav-item" data-page="profile">
    <svg viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
    <span>Profil</span>
  </div>
  <div class="nav-item" data-page="owner">
    <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="4"/><path d="M12 2v4M12 22v-4M4 12H2h2m16 0h2-2M5.636 5.636l2.828 2.828M15.536 15.536l2.828 2.828M5.636 18.364l2.828-2.828M15.536 8.464l2.828-2.828"/></svg>
    <span>Owner</span>
  </div>
</div>

<script>
  // FIREBASE init (config asli)
  const firebaseConfig = {
    apiKey: "AIzaSyC8QrDc5NiyyEZwl8sqBSVEPkymTkpgOiU",
    authDomain: "leetopia-auction.firebaseapp.com",
    databaseURL: "https://leetopia-auction-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "leetopia-auction",
    storageBucket: "leetopia-auction.firebasestorage.app",
    messagingSenderId: "396746559389",
    appId: "1:396746559389:web:21fa42ddc49366b6106974"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
  const storage = firebase.storage();

  const OWNER_PASSWORD = "12345";

  // ========== GLOBAL STATE ==========
  let currentUser = { growid: '', wa: '' };
  let selectedCurrency = 'WL';
  let auctionImageUrl = '';

  // ========== NAVIGATION ==========
  const pages = {
    auction: document.getElementById('pageAuction'),
    profile: document.getElementById('pageProfile'),
    owner: document.getElementById('pageOwner'),
    chat: document.getElementById('pageChat')
  };
  const navItems = document.querySelectorAll('.nav-item');

  function showPage(pageId) {
    Object.values(pages).forEach(p => p.classList.remove('active'));
    pages[pageId].classList.add('active');
    navItems.forEach(item => {
      item.classList.toggle('active', item.dataset.page === pageId);
    });
  }

  navItems.forEach(item => {
    item.addEventListener('click', () => showPage(item.dataset.page));
  });
  document.getElementById('profileMenuBtn').addEventListener('click', () => showPage('profile'));
  document.getElementById('ownerMenuBtn').addEventListener('click', () => showPage('owner'));

  // ========== PROFIL ==========
  function saveProfile() {
    const gid = document.getElementById('profileGrowid').value.trim();
    const wa = document.getElementById('profileWA').value.trim();
    if (!gid || !wa) { alert('Isi GrowID dan nomor WA'); return; }
    currentUser = { growid: gid, wa: wa };
    document.getElementById('profileForm').style.display = 'none';
    document.getElementById('profileDisplay').style.display = 'flex';
    document.getElementById('displayGrowid').innerText = gid;
    document.getElementById('displayWA').innerText = wa;
    document.getElementById('displayInitial').innerText = gid.substring(0,2).toUpperCase() || 'GT';
    localStorage.setItem('gtps_profile', JSON.stringify(currentUser));
  }

  function editProfile() {
    document.getElementById('profileForm').style.display = 'block';
    document.getElementById('profileDisplay').style.display = 'none';
    document.getElementById('profileGrowid').value = currentUser.growid;
    document.getElementById('profileWA').value = currentUser.wa;
  }

  const savedProfile = localStorage.getItem('gtps_profile');
  if (savedProfile) {
    currentUser = JSON.parse(savedProfile);
    document.getElementById('profileGrowid').value = currentUser.growid;
    document.getElementById('profileWA').value = currentUser.wa;
    saveProfile();
  }

  // ========== OWNER LOGIN ==========
  function loginOwner() {
    if (document.getElementById('ownerPass').value === OWNER_PASSWORD) {
      document.getElementById('ownerControls').style.display = 'block';
      alert('Owner login berhasil');
    } else {
      alert('Password salah');
    }
  }

  // ========== UPLOAD GAMBAR (storage) ==========
  function handleImageUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    const storageRef = storage.ref('auction_items/' + Date.now() + '.jpg');
    const task = storageRef.put(file);
    task.then(snapshot => snapshot.ref.getDownloadURL()).then(url => {
      auctionImageUrl = url;
      document.getElementById('previewImg').src = url;
      alert('Gambar siap');
    }).catch(err => {
      alert('Upload gagal, pakai preview lokal');
      const reader = new FileReader();
      reader.onload = e => { auctionImageUrl = e.target.result; document.getElementById('previewImg').src = e.target.result; };
      reader.readAsDataURL(file);
    });
  }

  // ========== MULAI LELANG ==========
  function startAuction() {
    const name = document.getElementById('itemName').value || 'Item';
    const qty = parseInt(document.getElementById('itemQty').value) || 1;
    const start = parseFloat(document.getElementById('startPriceBGL').value) || 0;
    const duration = parseInt(document.getElementById('duration').value) || 5;
    const endTime = Date.now() + duration * 60000;
    const image = auctionImageUrl || 'https://placehold.co/400x400/192132/f5b342?text=Item';

    // simpan current ke history dulu
    db.ref('auction/current').once('value', snap => {
      if (snap.exists()) db.ref('auctionHistory').push(snap.val());
    }).then(() => {
      db.ref('auction/current').set({
        itemName: name,
        itemQty: qty,
        highestBid: start,
        highestBidder: '-',
        endTime: endTime,
        imageUrl: image
      });
      db.ref('bids').remove();
      auctionImageUrl = '';
    });
  }

  // ========== KONVERSI MATA UANG ==========
  document.querySelectorAll('#currencyTabs span').forEach(tab => {
    tab.addEventListener('click', function() {
      document.querySelectorAll('#currencyTabs span').forEach(t => t.classList.remove('active'));
      this.classList.add('active');
      selectedCurrency = this.getAttribute('data-cur');
    });
  });

  function convertToBGL(amount, currency) {
    if (currency === 'WL') return amount / 100 / 100;
    if (currency === 'DL') return amount / 100;
    if (currency === 'BGL') return amount;
    if (currency === 'MGL') return amount * 100;
    return amount;
  }

  // ========== BID ==========
  function placeBid() {
    if (!currentUser.growid) { alert('Isi profil dulu'); showPage('profile'); return; }
    const amount = parseFloat(document.getElementById('bidAmount').value);
    if (isNaN(amount) || amount <= 0) { alert('Masukkan jumlah'); return; }
    const amountBGL = convertToBGL(amount, selectedCurrency);

    db.ref('auction/current').once('value', snap => {
      const data = snap.val();
      if (!data) { alert('Lelang tidak aktif'); return; }
      if (Date.now() > data.endTime) { alert('Lelang sudah selesai'); return; }

      if (amountBGL > data.highestBid) {
        db.ref('auction/current').update({ highestBid: amountBGL, hig
